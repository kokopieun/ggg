name: Ubuntu SSH with Tailscale

on: 
  workflow_dispatch:
    inputs:
      tailscale_authkey:
        description: 'TAILSCALE AUTH KEY'
        required: true
      computername:
        description: 'MACHINE NAME'
        default: 'ubuntu'
        required: true
      username:
        description: 'USERNAME'
        default: 'user'
        required: true
      password:
        description: 'USER PASSWORD'
        default: 'root'
        required: true

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3.0.2
    - name: Mask Code & Pin.
      run: |
        _AuthKey=$(jq -r '.inputs.tailscale_authkey' $GITHUB_EVENT_PATH)
        _CName=$(jq -r '.inputs.computername' $GITHUB_EVENT_PATH)
        _Pass=$(jq -r '.inputs.password' $GITHUB_EVENT_PATH)
        echo ::add-mask::$_AuthKey
        echo ::add-mask::$_CName
        echo ::add-mask::$_Pass
        echo TAILSCALE_AUTHKEY="$_AuthKey" >> $GITHUB_ENV
        echo ComputerName="$_CName" >> $GITHUB_ENV
        echo Password="$_Pass" >> $GITHUB_ENV
    - name: Setup Environment
      run: |
        sudo apt-get update
        bash Setup.sh
    - name: Check Services Status
      run: |
        echo "=== Checking SSH Service ==="
        sudo systemctl status ssh
        echo "=== Checking Tailscale ==="
        tailscale status
        echo "=== Network Status ==="
        sudo netstat -tlnp
    - name: IP for Connect to your SSH
      run: bash Ip.sh
    - name: Keep Alive
      run: |
        echo "VPS is running with Tailscale..."
        echo "Tailscale IP: $(tailscale ip -4)"
        echo "Use this IP to connect via SSH"
        while true; do
          sleep 60
          echo "Still alive... $(date)"
        done
